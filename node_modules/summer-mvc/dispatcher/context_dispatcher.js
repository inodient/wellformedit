const dispatchingInfo = require( require("path").join(process.cwd(), "dispatcher", "context_dispatcher.json") );
const ModelAndView = require( "./model_and_view.js" ).ModelAndView;




exports.dispatching = function( req, res ){

  return new Promise( function(resolve, reject){
    let mav = new ModelAndView();
    let method = req.method.toUpperCase();

    let dispatchingSpec = getDispatchingSpec( method, req._parsedUrl.pathname );

    let view = require("path").join( dispatchingSpec.viewPath, dispatchingSpec.view );

    getController( dispatchingSpec.controllerJS )
    .then( executeController.bind( null, dispatchingSpec.controlFunction, req, res ) )
    .then( makeModelAndView.bind( null, mav, view ) )
    .then( function( mav ){
      resolve( mav );
    } )
    .catch( console.error );
  } );
}




function getDispatchingSpec( method, reqPath ){
  let specifications = {};
  let dispatchingSpec = {};
  let length;

  if( method === "GET" ){
    specifications = dispatchingInfo[ "GET" ];
  } else if( method === "POST" ){
    specifications = dispatchingInfo[ "POST" ];
  }

  length = specifications.length;

  for( var i=0; i<length; i++ ){
    if( specifications[i].path === reqPath ){
      dispatchingSpec = specifications[i];
      break;
    }
  }

  return dispatchingSpec;
}

function getController( controllerJS ){
  let controller = require( require("path").join(process.cwd(), "controller", controllerJS) );

  return Promise.resolve( controller );
}

function executeController( controlFunction, req, res, controller ){
  return Promise.resolve( controller[ controlFunction ]( req, res ) );
}

function makeModelAndView( mav, view, model ){
  mav.model = model;
  mav.view = view;

  return Promise.resolve( mav );
}
